LIBNAME := libmetal

PROJECT_BASE:=$(abspath $(dir $(lastword $(MAKEFILE_LIST))))
OUTPUT_PATH:=$(PROJECT_BASE)/build-$(LIBNAME)
INSTALL_PATH:=$(LIB_OUTPUT_DIR)/$(LIBNAME)

include ../../../tools/make/rules.mk

INC_DIR += $(INSTALL_PATH)/usr/local/include/metal
LIB_CFLAGS := $(foreach subdir,$(sort $(INC_DIR)), -I$(subdir))
override LIB_CFLAGS += $(filter-out $(MKDEP_OPT),$(AL_CFLAGS))
LIB_LDFLAGS :=

.PHONY: build

CHIP       = dr1m90

$(OUTPUT_PATH)/Makefile:
	mkdir -p $(INSTALL_PATH) $(OUTPUT_PATH) \
	&& cd $(OUTPUT_PATH) \
	&& cmake $(PROJECT_BASE) -DCMAKE_C_FLAGS="$(LIB_CFLAGS)" \
							 -DMACHINE="$(CHIP)" \
							 -DCMAKE_SYSTEM_PROCESSOR="$(CORE)" \
							 -DCMAKE_EXE_LINKER_FLAGS="$(LIB_LDFLAGS)" \
							 -DCMAKE_SYSTEM_NAME="Generic" \
							 -DCMAKE_C_COMPILER="$(CC)" \
							 -DCMAKE_AR="$(AR)" \
							 -DCMAKE_C_COMPILER_FORCED=ON

$(LIBNAME)_obj:$(OUTPUT_PATH)/Makefile
	$(MAKE_COMMAND) -C $(OUTPUT_PATH) VERBOSE=1 DESTDIR=$(INSTALL_PATH) install

.PHONY: build
build: $(LIBNAME)_obj

.PHONY: clean_lib
clean_lib:
	@rm -rvf $(OUTPUT_PATH)
	@rm -rvf $(INSTALL_PATH)

lib: build
lib.do.clean:clean_lib
