#include "al_iic_hal.h"

AL_S32 AlIic_SclRecoveryTest()
{
    AL_S32 Ret;
    AL_IIC_HalStruct Handle;

    AL_IIC_InitStruct MasterInitConfig =
    {
        .Mode           = AL_IIC_MODE_MASTER,
        .AddrMode       = AL_IIC_ADDR_7BIT,
        .SpeedMode      = AL_IIC_FAST_MODE,
    };

    AL_U8 SendData[8] =
    {
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
    };
    AL_U16 SlaveAddr = 0x77;

    Ret = AlIic_Hal_Init(&Handle, 1, &MasterInitConfig, AL_NULL);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_Init Failed\r\n");
    }

    /* Last byte without STOP command will cause SCL at low */
    AlIic_Hal_MasterSetCmdOption(&Handle, AL_IIC_CMD_OPTION_NO_STOP_RESTART);

    Ret = AlIic_Hal_MasterSendDataBlock(&Handle, SlaveAddr, SendData, 8, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterSendDataBlock Failed\r\n");
    }

    return AL_OK;
}

AL_S32 AlIic_BusClearFeatureTest()
{
    AlIic_SclRecoveryTest();

}

AL_S32 AlIic_E2promTest()
{
    AL_S32 Ret;
    AL_U16 Index;
    AL_U8 TestFail = 0;
    AL_IIC_HalStruct Handle;
    AL_U32 DelayCnt = 0;
    AL_U16 ReadWriteAddr = 0x0000;
    AL_U16 SlaveAddr = 0x50;

    AL_IIC_InitStruct InitConfig =
    {
        .Mode           = AL_IIC_MODE_MASTER,
        .AddrMode       = AL_IIC_ADDR_7BIT,
        .SpeedMode      = AL_IIC_FAST_MODE,
    };
    AL_U8 WriteBuffer[130] =
    {
        0x00, 0x00, //Read addr 0x00
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
    };
    AL_U8 ReadBuffer[128] = {0};

    Ret = AlIic_Hal_Init(&Handle, 0, &InitConfig, AL_NULL);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_Init Failed\r\n");
    }
    AlIntr_SetGlobalInterrupt(AL_FUNC_ENABLE);

    /* Page write, Include address */
    Ret = AlIic_Hal_MasterSendDataBlock(&Handle, SlaveAddr, WriteBuffer, 130, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterSendDataBlock Failed\r\n");
    }

    /* delay > 10ms for write complete */
    do {
        DelayCnt++;
    } while(DelayCnt < 0xFFF);

    /* Send read address */
    Ret = AlIic_Hal_MasterSendDataBlock(&Handle, SlaveAddr, (AL_U8*)&ReadWriteAddr, 2, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterSendDataBlock Failed\r\n");
    }

    /* Read data from e2prom */
    Ret = AlIic_Hal_MasterRecvDataBlock(&Handle, SlaveAddr, ReadBuffer, 128, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterRecvDataBlock Failed\r\n");
    }

    for(Index = 0; Index < 128; Index++) {
        if (WriteBuffer[Index+2] != ReadBuffer[Index]) {
            TestFail = 1;
            break;
        }
    }
    if (TestFail) {
        printf("E2prom write read test fail\r\n");
    } else {
        printf("E2prom write read test pass\r\n");
    }

}

#define AL_IIC_TEST_MASTER_TX
//#define AL_IIC_TEST_MASTER_RX
//#define AL_IIC_TEST_SLAVE_TX
//#define AL_IIC_TEST_SLAVE_RX

AL_S32 AlIic_TransRecvTest()
{
    AL_S32 Ret;
    AL_IIC_HalStruct Handle;
#if defined (AL_IIC_TEST_MASTER_TX) || defined (AL_IIC_TEST_MASTER_RX)
    AL_IIC_InitStruct MasterInitConfig =
    {
        .Mode           = AL_IIC_MODE_MASTER,
        .AddrMode       = AL_IIC_ADDR_7BIT,
        .SpeedMode      = AL_IIC_FAST_MODE,
    };
#else

    AL_IIC_InitStruct SlaveInitConfig =
    {
        .Mode           = AL_IIC_MODE_SLAVE,
        .AddrMode       = AL_IIC_ADDR_7BIT,
        .SpeedMode      = AL_IIC_FAST_MODE,
        .SarAddress     = 0x77,
    };
#endif

    AL_U8 SendData[256] =
    {
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
    };

    AL_U8 RecvData[256] =
    {
        0,
    };

#if defined (AL_IIC_TEST_MASTER_TX) || defined (AL_IIC_TEST_MASTER_RX)
    AL_U16 SlaveAddr = 0x77;

    Ret = AlIic_Hal_Init(&Handle, 1, &MasterInitConfig, AL_NULL);
#else
    Ret = AlIic_Hal_Init(&Handle, 1, &SlaveInitConfig, AL_NULL);
#endif
    if (Ret != AL_OK) {
        printf("AlIic_Hal_Init Failed\r\n");
    }
    AlIntr_SetGlobalInterrupt(AL_FUNC_ENABLE);

#ifdef AL_IIC_TEST_MASTER_TX
    Ret = AlIic_Hal_MasterSendDataBlock(&Handle, SlaveAddr, SendData, 256, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterSendDataBlock Failed\r\n");
    }
#endif

#ifdef AL_IIC_TEST_MASTER_RX
    Ret = AlIic_Hal_MasterRecvDataBlock(&Handle, SlaveAddr, RecvData , 256, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_MasterRecvDataBlock Failed\r\n");
    }

    for (int i = 0; i < 256; i++)
    {
        printf("0x%x ", RecvData[i]);
        if ((i+1) % 32 == 0) {
            printf("\r\n");
        }
    }
    printf("\r\n");
#endif

#ifdef AL_IIC_TEST_SLAVE_TX
    Ret = AlIic_Hal_SlaveSendDataBlock(&Handle, SendData, 256, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_SlaveSendDataBlock Failed\r\n");
    }
#endif

#ifdef AL_IIC_TEST_SLAVE_RX
    Ret = AlIic_Hal_SlaveRecvDataBlock(&Handle, RecvData, 256, 0);
    if (Ret != AL_OK) {
        printf("AlIic_Hal_SlaveRecvDataBlock Failed\r\n");
    }

    for (int i = 0; i < 256; i++)
    {
        printf("0x%x ", RecvData[i]);
        if ((i+1) % 32 == 0) {
            printf("\r\n");
        }
    }
    printf("\r\n");
#endif

    return 0;
}

int main()
{
    AlIic_TransRecvTest();

    AlIic_E2promTest();

    AlIic_BusClearFeatureTest();

    return 0;
}
